name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

jobs:
  test-root:
    runs-on: ubuntu-latest
    env:
      GOWORK: off
    strategy:
      fail-fast: false
      matrix:
        include:
          - go-version: "1.21.x"
            go-label: go121
          - go-version: "1.26.x"
            go-label: go126
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go-version }}
          cache: true
          cache-dependency-path: |
            go.mod
            go.sum
            prometheus/go.mod
            prometheus/go.sum
      - run: go test -v -p 1 -count=1 -shuffle=on ./...
      - run: go test -race ./...
      - run: go test -coverprofile=coverage.out ./...
      - run: go tool cover -func=coverage.out
      - uses: actions/upload-artifact@v6
        with:
          name: coverage-root-${{ matrix.go-label }}
          path: coverage.out
      - run: before="$(git status --porcelain -- go.mod go.sum)"; go mod tidy; after="$(git status --porcelain -- go.mod go.sum)"; test "$before" = "$after"

  test-adapter-consumer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: "1.26.x"
          cache: true
          cache-dependency-path: |
            go.mod
            go.sum
            prometheus/go.mod
            prometheus/go.sum
      - run: GOWORK=off go -C prometheus test -v -p 1 -count=1 -shuffle=on ./...
      - run: GOWORK=off go -C prometheus test -race ./...
      - run: GOWORK=off go -C prometheus test -coverprofile=../coverage-prometheus.out ./...
      - run: GOWORK=off go -C prometheus tool cover -func=../coverage-prometheus.out
      - uses: actions/upload-artifact@v6
        with:
          name: coverage-prometheus-go126
          path: coverage-prometheus.out
      - run: before="$(git status --porcelain -- prometheus/go.mod prometheus/go.sum)"; GOWORK=off go -C prometheus mod tidy; after="$(git status --porcelain -- prometheus/go.mod prometheus/go.sum)"; test "$before" = "$after"

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: "1.26.x"
          cache: true
          cache-dependency-path: |
            go.mod
            go.sum
            prometheus/go.mod
            prometheus/go.sum
      - uses: extractions/setup-just@v3
      - run: go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.8.0
      - run: just lint

  actionlint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: "1.26.x"
          cache: true
          cache-dependency-path: |
            go.mod
            go.sum
            prometheus/go.mod
            prometheus/go.sum
      - uses: extractions/setup-just@v3
      - run: go install github.com/rhysd/actionlint/cmd/actionlint@v1.7.10
      - run: just actionlint
